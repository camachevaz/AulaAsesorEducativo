---
title: Пример подключения аудита к существующему Web-приложению с использованием перегенерации проекта
sidebar: flexberry-aspnet_sidebar
keywords: Flexberry ASP-NET, Flexberry Audit, Flexberry Designer
toc: true
permalink: ru/fa_audit-web-example.html
lang: ru
---

{% include note.html content="Если перегенерировать проект нет желания\возможности
следует ознакомиться со статьей [Пример подключения аудита к существующему Web-приложению без использования перегенерации проекта](fa_audit-web-example-manual.html)" %}

## Подключение аудита

Подключение аудита к существующей системе будет рассмотрено на примере.

### Задача

Добавить аудирование создаваемых и удаляемых объектов в существующую систему. Также необходимо вести аудит изменения для класса `Кредит`

## Диаграмма классов

![](/images/pages/products/flexberry-aspnet/audit/filter-ex-diagram.png)

### Настройка аудита

#### Настройка базы данных

Для начала необходимо настроить базу данных аудита. Для этого форму настройки [свойств стадии](fo_audit-setup.html).

![](/images/pages/products/flexberry-aspnet/audit/audit_app-settings.png)

База аудита может храниться как в отдельной базе, так и в базе приложения. Это определяется настройкой `БД аудита в БД приложения`. Если принято решение хранить данные вместе. Установим эту настройку, а также настройку `Не удалять существующие таблицы`.

Сохранть настройки и закрыть форму.

#### Настройка стадии

Открыть форму настройки стадии и перейти на вкладку `Настройка аудита`

![](/images/pages/products/flexberry-aspnet/audit/audit-settings-stady.png)

* Нажать кнопку `Включить аудит во всех классах` ([подробнее](fo_audit-setup.html))

* Сохранить настройки и закрыть форму

#### Настройка классов

Аудит операций создания и удаления включается по умолчанию. Следовательно, чтобы выполнить поставленную задачу, необходимо включить аудит операции изменения для класса `Кредит`.

Открть свойства класса `Кредит` и установить настройку `Вести аудит операции изменения`.

![](/images/pages/products/flexberry-aspnet/audit/audit-settings-class.png)

Сохранить настройки и закрыть форму.

#### Настройка класса со стереотипом Application

### Генерация приложения

Чтобы сгенерировать приложение, необходимо:

* [Привести в соответствие базу данных приложения](fd_matching-db.html)
* Сгенерировать классы
* Скомпилировать классы
* Сгенерировать ASP.NET приложение

### Результат

В проект добавились [web-страницы для отображения аудита](fa_audit-web-forms.html):

![](/images/pages/products/flexberry-aspnet/audit/audit-files-in-project.png)

В каждый класс данных (класс со стереотипом [Implementation](fd_data-classes.html)) добавился класс AuditSettings, хранящий настройки аудита для этого класса.

Помимо этого, в классы добавились представления для аудита `AuditView`, а также 4 новых поля: `Creator`, `CreateTime`, `Editor`, `EditTime` - последствия выставления настройки Добавить поля аудита ([подробнее](efs_flexberry-audit-object-fields.html)).

#### Просмотр операций аудита

Как уже упоминалось выше, в проекте появились [web-страницы для просмотра данных аудита](fa_audit-web-forms.html). По умолчанию файл конфигурации, отвечающий за эти страницы (файл лежит в папке forms\audit, изображен на рисунке выше), выглядит следующим образом:

```xml
<authorization>
  <deny users="?"/>
  <allow roles="admin" />
  <deny users="*" />
</authorization>
```

Это означает, что доступ закрыт для всех пользователей, исключая пользователей с ролью admin ([подробнее в MSDN](https://msdn.microsoft.com/ru-ru/library/8aeskccd(v=vs.90).aspx))

Чтобы не заниматься конфигурированием системы полномочий, следует изменить файл конфигурации следующим образом:

```xml
<authorization>
  <deny users="?"/>
</authorization>
```

Таким образом, доступ к этим страницам будет запрещен только неавторизованным пользователям.

Ссылки на страницу `AuditEntityL.aspx` можно вынести на [рабочий стол](fa_add-page-web-desktop.html) или просто ввести в адресную строку адрес страницы.

На форме можно увидеть стандартный [WebObjectListView](fa_web-object-list-view.html) пока пустой, т.к. аудированных операций еще не было совершено.

Далее можно создать нового `Клиента`, изменить существующий `Кредит`, а затем обновим форму отображения данных аудита:

![](/images/pages/products/flexberry-aspnet/audit/audit-wolv.png)

Как можно заметить, фиксируется время и тип операции; объект, над которым была произведена операция (его primaryKey); кем и откуда была произведена операция, а также результат выполнения операции.
